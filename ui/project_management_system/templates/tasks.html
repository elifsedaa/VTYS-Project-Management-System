{% extends "base.html" %}

{% block page_title %}Görevler{% endblock %}

{% block heading %}Görevler{% endblock %}

{% block content %}
<div class="btn-group">
    <button class="btn-primary" onclick="addTask()">
        <i class="fas fa-plus"></i> Yeni Görev Ekle
    </button>
    <select onchange="if(this.value) location.href='/tasks?project='+this.value; else location.href='/tasks';" 
            style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;">
        <option value="">Tüm Projeler</option>
        {% for p in projects %}
        <option value="{{ p.project_id }}">{{ p.project_name }}</option>
        {% endfor %}
    </select>
    <input type="text" id="taskSearch" placeholder="Görev ara..." 
           onkeyup="filterTable('taskSearch', 'tasksTable')" 
           style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; width: 300px;">
</div>

<div class="content-card">
    <h2><i class="fas fa-tasks"></i> Tüm Görevler</h2>
    <div class="table-container">
        <table id="tasksTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Görev</th>
                    <th>Proje</th>
                    <th>Atanan</th>
                    <th>Öncelik</th>
                    <th>Durum</th>
                    <th>Deadline</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
                {% for t in tasks %}
                <tr>
                    <td><strong>#{{ t.task_id }}</strong></td>
                    <td><strong>{{ t.task_title }}</strong></td>
                    <td>{{ t.project_name }}</td>
                    <td>{{ t.EmployeeName }}</td>
                    <td>
                        {% if t.priority == 'Yüksek' %}
                            <span class="badge danger">{{ t.priority }}</span>
                        {% elif t.priority == 'Orta' %}
                            <span class="badge warning">{{ t.priority }}</span>
                        {% else %}
                            <span class="badge success">{{ t.priority }}</span>
                        {% endif %}
                    </td>
                    <td><span class="badge primary">{{ t.status }}</span></td>
                    <td>{{ t.due_date.strftime('%d.%m.%Y') if t.due_date else '-' }}</td>
                    <td>
                        {% if t.status != 'Tamamlandı' %}
                        <button class="btn-success btn-sm" onclick="changeTaskStatus({{ t.task_id }}, 'Tamamlandı')">
                            <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                        <button class="btn-warning btn-sm" onclick="editTask({{ t.task_id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-danger btn-sm" onclick="deleteTask({{ t.task_id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="taskModalTitle">Yeni Görev Ekle</h2>
            <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
        </div>
        <form id="taskForm" class="modal-form" onsubmit="saveTask(event)">
            <input type="hidden" id="taskId">
            <div class="form-group">
                <label>Görev Başlığı *</label>
                <input type="text" name="task_title" id="taskTitle" required>
            </div>
            <div class="form-group">
                <label>Açıklama</label>
                <textarea name="task_description" id="taskDescription"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Proje *</label>
                    <select name="project_id" id="taskProject" required>
                        {% for p in projects %}
                        <option value="{{ p.project_id }}">{{ p.project_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Atanan Kişi *</label>
                    <select name="employee_id" id="taskEmployee" required>
                        {% for e in employees %}
                        <option value="{{ e.EmployeeID }}">{{ e.FirstName }} {{ e.LastName }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Öncelik</label>
                    <select name="priority" id="taskPriority">
                        <option value="Düşük">Düşük</option>
                        <option value="Orta" selected>Orta</option>
                        <option value="Yüksek">Yüksek</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Başlangıç Tarihi *</label>
                    <input type="date" name="start_date" id="taskStartDate" required>
                </div>
            </div>
            <div class="form-group">
                <label>Bitiş Tarihi *</label>
                <input type="date" name="due_date" id="taskDueDate" required>
            </div>
            <button type="submit" class="btn-primary">
                <i class="fas fa-save"></i> Kaydet
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const addTask = () => {
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskModalTitle').textContent = 'Yeni Görev Ekle';
    
    // Bugünün tarihini set et
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('taskStartDate').value = today;
    
    openModal('taskModal');
};

const editTask = async (id) => {
    const response = await fetch(`/api/tasks?id=${id}`);
    const data = await response.json();
    const task = data.task;
    
    document.getElementById('taskId').value = task.task_id;
    document.getElementById('taskTitle').value = task.task_title;
    document.getElementById('taskDescription').value = task.task_description || '';
    document.getElementById('taskProject').value = task.project_id;
    document.getElementById('taskEmployee').value = task.EmployeeID;
    document.getElementById('taskPriority').value = task.priority;
    document.getElementById('taskStartDate').value = task.start_date.split('T')[0];
    document.getElementById('taskDueDate').value = task.due_date.split('T')[0];
    
    document.getElementById('taskModalTitle').textContent = 'Görev Düzenle';
    openModal('taskModal');
};

const saveTask = async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        project_id: parseInt(formData.get('project_id')),
        employee_id: parseInt(formData.get('employee_id')),
        task_title: formData.get('task_title'),
        task_description: formData.get('task_description'),
        priority: formData.get('priority'),
        start_date: formData.get('start_date'),
        due_date: formData.get('due_date')
    };
    
    const taskId = document.getElementById('taskId').value;
    const method = taskId ? 'PUT' : 'POST';
    
    if (taskId) {
        data.task_id = parseInt(taskId);
    }
    
    try {
        const response = await fetch('/api/tasks', {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message);
            closeModal('taskModal');
            location.reload();
        } else {
            showAlert(result.message || 'İşlem başarısız', 'error');
        }
    } catch (error) {
        showAlert('Bir hata oluştu', 'error');
    }
};

const changeTaskStatus = async (taskId, newStatus) => {
    if (!confirm('Görevi tamamlandı olarak işaretlemek istiyor musunuz?')) return;
    
    try {
        const response = await fetch('/api/tasks', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, status: newStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message);
            location.reload();
        } else {
            showAlert(result.message || 'İşlem başarısız', 'error');
        }
    } catch (error) {
        showAlert('Bir hata oluştu', 'error');
    }
};

const deleteTask = async (id) => {
    if (!confirm('Bu görevi silmek istediğinizden emin misiniz?')) return;
    
    try {
        const response = await fetch(`/api/tasks?id=${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message);
            location.reload();
        } else {
            showAlert(result.message || 'Silme işlemi başarısız', 'error');
        }
    } catch (error) {
        showAlert('Bir hata oluştu', 'error');
    }
};
</script>
{% endblock %}